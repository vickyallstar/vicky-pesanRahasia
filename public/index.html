<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Message - Buat Pesan Rahasia</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤« Secret Message</h1>
            <p class="subtitle">Buat pesan rahasia yang akan otomatis terhapus setelah 12 jam</p>
        </header>

        <main>
            <div class="card">
                <form id="messageForm">
                    <div class="form-group">
                        <label for="message">Pesan Rahasia:</label>
                        <textarea 
                            id="message" 
                            name="message" 
                            rows="8" 
                            placeholder="Tulis pesan rahasiamu di sini..." 
                            maxlength="5000"
                            required
                        ></textarea>
                        <div class="char-counter">
                            <span id="charCount">0</span>/5000 karakter
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="btn-primary">
                        <span class="btn-text">Buat Link Rahasia</span>
                        <span class="loading-spinner" style="display: none;">â³</span>
                    </button>
                </form>
            </div>

            <div id="result" class="result-card" style="display: none;">
                <h3>âœ… Link Rahasia Berhasil Dibuat!</h3>
                <p>Link ini akan aktif selama 12 jam:</p>
                <div class="url-container">
                    <input type="text" id="secretUrl" readonly>
                    <button id="copyBtn" class="btn-secondary" onclick="copyUrl()">ğŸ“‹ Salin</button>
                </div>
                <p class="expiry-info" id="expiryInfo"></p>
                <button onclick="createNew()" class="btn-link">Buat pesan baru lagi</button>
            </div>

            <div id="error" class="error-message" style="display: none;"></div>
            <div id="debugInfo" style="background: #f0f0f0; padding: 10px; margin-top: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; display: none;"></div>
        </main>

        <footer>
            <p>ğŸ”’ Pesan akan otomatis terhapus setelah 12 jam</p>
        </footer>
    </div>

    <script>
        const form = document.getElementById('messageForm');
        const messageInput = document.getElementById('message');
        const charCount = document.getElementById('charCount');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const loadingSpinner = submitBtn.querySelector('.loading-spinner');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        const debugDiv = document.getElementById('debugInfo');
        const secretUrl = document.getElementById('secretUrl');
        const expiryInfo = document.getElementById('expiryInfo');

        // Update character counter
        messageInput.addEventListener('input', () => {
            const count = messageInput.value.length;
            charCount.textContent = count;
        });

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const content = messageInput.value.trim();
            
            if (!content) {
                showError('Pesan tidak boleh kosong');
                return;
            }

            // Show loading state
            setLoading(true);
            hideError();
            hideResult();
            hideDebug();

            try {
                console.log('ğŸš€ Mengirim request ke /v1/create');
                console.log('ğŸ“¦ Content:', content);
                
                const response = await fetch('/v1/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content })
                });

                console.log('ğŸ“¥ Response status:', response.status);
                console.log('ğŸ“¥ Response headers:', [...response.headers.entries()]);

                // Cek content type
                const contentType = response.headers.get('content-type');
                console.log('ğŸ“¥ Content-Type:', contentType);

                // TAMPILIN DEBUG INFO
                let debugText = `Status: ${response.status}\n`;
                debugText += `Content-Type: ${contentType}\n\n`;

                // Coba baca response sebagai text dulu
                const responseText = await response.text();
                console.log('ğŸ“¥ Response text (first 200 chars):', responseText.substring(0, 200));
                
                // Tampilkan di debug div
                debugText += `Response:\n${responseText.substring(0, 500)}`;
                showDebug(debugText);

                // Coba parse JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('ğŸ“¥ Response JSON:', data);
                } catch (jsonError) {
                    console.error('âŒ Gagal parse JSON:', jsonError);
                    
                    // Kalau response diawali <!DOCTYPE, berarti dapet HTML
                    if (responseText.trim().startsWith('<!DOCTYPE')) {
                        throw new Error('Server mengembalikan halaman HTML, bukan JSON. Kemungkinan route /v1/create tidak ditemukan.');
                    } else {
                        throw new Error(`Server mengembalikan: ${responseText.substring(0, 100)}`);
                    }
                }

                if (!response.ok) {
                    throw new Error(data.error || `HTTP Error ${response.status}`);
                }

                if (!data.success) {
                    throw new Error(data.error || 'Gagal membuat pesan');
                }

                // Show success result
                secretUrl.value = data.data.url;
                
                const expiryDate = new Date(data.data.expiresAt);
                expiryInfo.textContent = `Berlaku sampai: ${expiryDate.toLocaleString('id-ID')}`;
                
                showResult();
                form.reset();
                charCount.textContent = '0';
                hideDebug();

            } catch (error) {
                console.error('âŒ Error detail:', error);
                showError(error.message);
            } finally {
                setLoading(false);
            }
        });

        // Copy URL to clipboard
        window.copyUrl = async () => {
            try {
                await navigator.clipboard.writeText(secretUrl.value);
                const copyBtn = document.getElementById('copyBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ… Tersalin!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            } catch (err) {
                showError('Gagal menyalin link');
            }
        };

        // Create new message
        window.createNew = () => {
            hideResult();
            messageInput.focus();
        };

        // Helper functions
        function setLoading(isLoading) {
            if (isLoading) {
                btnText.style.display = 'none';
                loadingSpinner.style.display = 'inline';
                submitBtn.disabled = true;
            } else {
                btnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        function showError(message) {
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
        }

        function showResult() {
            resultDiv.style.display = 'block';
        }

        function hideResult() {
            resultDiv.style.display = 'none';
        }

        function showDebug(text) {
            debugDiv.textContent = text;
            debugDiv.style.display = 'block';
        }

        function hideDebug() {
            debugDiv.style.display = 'none';
        }

        // Test API health on load
        (async function testHealth() {
            try {
                const response = await fetch('/v1/health');
                const text = await response.text();
                console.log('ğŸ¥ Health check response:', text);
            } catch (err) {
                console.error('ğŸ¥ Health check failed:', err);
            }
        })();
    </script>
</body>
</html>
